<template>
  <div class="min-h-screen bg-gray-50">
    <!-- Top Bar -->
    <div class="bg-white shadow-sm border-b">
      <div class="container mx-auto px-4 py-4 flex justify-between items-center">
        <div>
          <h1 class="text-2xl font-bold text-primary-600">
            {{ isRTL ? 'ğŸ¨ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø®ÙŠÙ…Ø©' : 'ğŸ¨ Al Khayma Dashboard' }}
          </h1>
          <p class="text-sm text-gray-600">{{ isRTL ? 'Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ' : 'Welcome back' }}</p>
        </div>
        <router-link to="/" class="btn-primary">
          {{ isRTL ? 'â† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©' : 'Home â†’' }}
        </router-link>
      </div>
    </div>

    <div class="container mx-auto px-4 py-8">
      <!-- Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="card bg-gradient-to-br from-blue-500 to-blue-600 text-white hover:shadow-xl transition-shadow">
          <div class="flex justify-between items-start mb-2">
            <p class="text-blue-100">{{ isRTL ? 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª' : 'Total Bookings' }}</p>
            <span class="text-3xl">ğŸ“Š</span>
          </div>
          <p class="text-4xl font-bold">{{ stats.totalBookings }}</p>
          <p class="text-sm text-blue-100 mt-2">{{ isRTL ? 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª' : 'All time' }}</p>
        </div>

        <div class="card bg-gradient-to-br from-green-500 to-green-600 text-white hover:shadow-xl transition-shadow">
          <div class="flex justify-between items-start mb-2">
            <p class="text-green-100">{{ isRTL ? 'Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©' : 'Active Bookings' }}</p>
            <span class="text-3xl">âœ…</span>
          </div>
          <p class="text-4xl font-bold">{{ stats.activeBookings }}</p>
          <p class="text-sm text-green-100 mt-2">{{ isRTL ? 'Ù…Ø¤ÙƒØ¯Ø©' : 'Confirmed' }}</p>
        </div>

        <div class="card bg-gradient-to-br from-yellow-500 to-yellow-600 text-white hover:shadow-xl transition-shadow">
          <div class="flex justify-between items-start mb-2">
            <p class="text-yellow-100">{{ isRTL ? 'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª' : 'Revenue' }}</p>
            <span class="text-3xl">ğŸ’°</span>
          </div>
          <p class="text-4xl font-bold">${{ stats.revenue.toLocaleString() }}</p>
          <p class="text-sm text-yellow-100 mt-2">{{ isRTL ? 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ' : 'Total' }}</p>
        </div>

        <div class="card bg-gradient-to-br from-purple-500 to-purple-600 text-white hover:shadow-xl transition-shadow">
          <div class="flex justify-between items-start mb-2">
            <p class="text-purple-100">{{ isRTL ? 'Ø§Ù„ØºØ±Ù Ø§Ù„Ù…ØªØ§Ø­Ø©' : 'Available Rooms' }}</p>
            <span class="text-3xl">ğŸ¨</span>
          </div>
          <p class="text-4xl font-bold">{{ stats.availableRooms }}</p>
          <p class="text-sm text-purple-100 mt-2">{{ isRTL ? 'Ù…Ù† 50' : 'of 50' }}</p>
        </div>
      </div>

      <!-- Tabs -->
      <div class="bg-white rounded-lg shadow-sm mb-6">
        <div class="flex border-b overflow-x-auto">
          <button 
            @click="activeTab = 'bookings'" 
            :class="activeTab === 'bookings' ? 'border-b-2 border-primary-600 text-primary-600 font-bold' : 'text-gray-600'"
            class="px-6 py-4 whitespace-nowrap hover:bg-gray-50 transition-colors"
          >
            ğŸ“‹ {{ isRTL ? 'Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª' : 'Bookings' }}
            <span class="ml-2 px-2 py-1 bg-primary-100 text-primary-600 rounded-full text-xs">
              {{ bookings.length }}
            </span>
          </button>
          <button 
            @click="activeTab = 'rooms'" 
            :class="activeTab === 'rooms' ? 'border-b-2 border-primary-600 text-primary-600 font-bold' : 'text-gray-600'"
            class="px-6 py-4 whitespace-nowrap hover:bg-gray-50 transition-colors"
          >
            ğŸ¨ {{ isRTL ? 'Ø§Ù„ØºØ±Ù' : 'Rooms' }}
          </button>
          <button 
            @click="activeTab = 'products'" 
            :class="activeTab === 'products' ? 'border-b-2 border-primary-600 text-primary-600 font-bold' : 'text-gray-600'"
            class="px-6 py-4 whitespace-nowrap hover:bg-gray-50 transition-colors"
          >
            ğŸ½ï¸ {{ isRTL ? 'Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª' : 'Products' }}
          </button>
        </div>
      </div>

      <!-- Bookings Tab -->
      <div v-if="activeTab === 'bookings'" class="card">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-bold">{{ isRTL ? 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª' : 'All Bookings' }}</h2>
          
          <select v-model="statusFilter" class="input w-48">
            <option value="">{{ isRTL ? 'ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª' : 'All Status' }}</option>
            <option value="pending">Pending</option>
            <option value="confirmed">Confirmed</option>
            <option value="cancelled">Cancelled</option>
            <option value="completed">Completed</option>
          </select>
        </div>
        
        <div v-if="loading" class="text-center py-8">{{ t('common.loading') }}</div>
        
        <div v-else class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ID</th>
                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">{{ isRTL ? 'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¶ÙŠÙ' : 'Guest Info' }}</th>
                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">{{ isRTL ? 'Ø§Ù„Ù†ÙˆØ¹' : 'Type' }}</th>
                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">{{ isRTL ? 'Ø§Ù„ØªØ§Ø±ÙŠØ®' : 'Date' }}</th>
                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">{{ isRTL ? 'Ø§Ù„Ø³Ø¹Ø±' : 'Price' }}</th>
                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">{{ isRTL ? 'Ø§Ù„Ø­Ø§Ù„Ø©' : 'Status' }}</th>
                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">{{ isRTL ? 'Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª' : 'Actions' }}</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <tr v-for="booking in filteredBookings" :key="booking.id" class="hover:bg-gray-50 transition-colors">
                <td class="px-4 py-3">
                  <span class="font-mono text-sm font-semibold text-primary-600">#{{ booking.id }}</span>
                </td>
                <td class="px-4 py-3">
                  <div v-if="booking.special_requests" class="text-sm">
                    <div class="font-semibold text-gray-900">{{ extractGuestName(booking.special_requests) }}</div>
                    <div class="text-gray-600">{{ extractGuestEmail(booking.special_requests) }}</div>
                    <div class="text-gray-500">{{ extractGuestPhone(booking.special_requests) }}</div>
                  </div>
                  <div v-else class="text-gray-400 text-sm">User {{ booking.user_id }}</div>
                </td>
                <td class="px-4 py-3">
                  <div class="text-sm">
                    <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-medium">
                      {{ getTypeLabel(booking.booking_type) }}
                    </span>
                    <div v-if="isActivityType(booking.booking_type)" class="text-gray-600 mt-1">
                      ğŸ‘¥ {{ booking.guests }} {{ isRTL ? 'Ø´Ø®Øµ' : 'people' }}
                    </div>
                  </div>
                </td>
                <td class="px-4 py-3">
                  <div class="text-sm text-gray-600">
                    <div>ğŸ“… {{ formatDate(booking.booking_date) }}</div>
                    <div v-if="isActivityType(booking.booking_type)" class="text-gray-500">
                      ğŸ• {{ formatTime(booking.booking_date) }}
                    </div>
                  </div>
                </td>
                <td class="px-4 py-3">
                  <div class="text-sm">
                    <span class="font-semibold text-gray-900">${{ Number(booking.total_price).toLocaleString() }}</span>
                    <div v-if="isActivityType(booking.booking_type) && booking.guests > 1" class="text-gray-500 text-xs">
                      (${{ (Number(booking.total_price) / booking.guests).toFixed(0) }} Ã— {{ booking.guests }})
                    </div>
                  </div>
                </td>
                <td class="px-4 py-3">
                  <span :class="getStatusClass(booking.status)" class="px-3 py-1 rounded-full text-xs font-semibold">
                    {{ booking.status }}
                  </span>
                </td>
                <td class="px-4 py-3">
                  <div class="flex gap-2">
                    <button 
                      v-if="booking.status === 'pending'"
                      @click="updateStatus(booking.id, 'confirmed')" 
                      class="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600 text-xs font-medium transition-colors"
                    >
                      âœ“ {{ isRTL ? 'ØªØ£ÙƒÙŠØ¯' : 'Confirm' }}
                    </button>
                    <button 
                      v-if="booking.status !== 'cancelled'"
                      @click="updateStatus(booking.id, 'cancelled')" 
                      class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-xs font-medium transition-colors"
                    >
                      âœ• {{ isRTL ? 'Ø¥Ù„ØºØ§Ø¡' : 'Cancel' }}
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
          
          <div v-if="filteredBookings.length === 0" class="text-center py-12">
            <p class="text-gray-500 text-lg">{{ isRTL ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª' : 'No bookings found' }}</p>
          </div>
        </div>
      </div>

      <!-- Rooms Tab -->
      <div v-if="activeTab === 'rooms'" class="card">
        <h2 class="text-2xl font-bold mb-4">{{ isRTL ? 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØºØ±Ù' : 'Manage Rooms' }}</h2>
        <p class="text-gray-600">{{ isRTL ? 'Ù‚Ø±ÙŠØ¨Ø§Ù‹' : 'Coming soon' }}</p>
      </div>

      <!-- Products Tab -->
      <div v-if="activeTab === 'products'" class="card">
        <h2 class="text-2xl font-bold mb-4">{{ isRTL ? 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª' : 'Manage Products' }}</h2>
        <p class="text-gray-600">{{ isRTL ? 'Ù‚Ø±ÙŠØ¨Ø§Ù‹' : 'Coming soon' }}</p>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted } from 'vue'
import { useRouter } from 'vue-router'
import { useI18n } from 'vue-i18n'
import { useAuthStore } from '@/stores/auth'
import { useAppStore } from '@/stores/app'
import { bookingsApi } from '@/api/bookings'
import apiClient from '@/api/client'
import type { Booking } from '@/types'

const { t } = useI18n()
const router = useRouter()
const authStore = useAuthStore()
const appStore = useAppStore()

const activeTab = ref('bookings')
const loading = ref(true)
const bookings = ref<Booking[]>([])
const statusFilter = ref('')
const isRTL = computed(() => appStore.isRTL)

const filteredBookings = computed(() => {
  if (!statusFilter.value) return bookings.value
  return bookings.value.filter(b => b.status === statusFilter.value)
})

const stats = computed(() => ({
  totalBookings: bookings.value.length,
  activeBookings: bookings.value.filter(b => b.status === 'confirmed').length,
  revenue: bookings.value.reduce((sum, b) => sum + Number(b.total_price), 0),
  availableRooms: 45
}))

async function loadBookings() {
  try {
    bookings.value = await bookingsApi.getAll()
  } catch (error) {
    console.error('Failed to load bookings:', error)
  } finally {
    loading.value = false
  }
}

function extractGuestName(specialRequests: string) {
  const match = specialRequests.match(/Guest: (.+?),/)
  return match ? match[1] : 'N/A'
}

function extractGuestEmail(specialRequests: string) {
  const match = specialRequests.match(/Email: (.+?),/)
  return match ? match[1] : 'N/A'
}

function extractGuestPhone(specialRequests: string) {
  const match = specialRequests.match(/Phone: (.+?)(?:,|$)/)
  return match ? match[1] : 'N/A'
}

function formatDate(date: string) {
  return new Date(date).toLocaleDateString(isRTL.value ? 'ar-SA' : 'en-US')
}

function formatTime(date: string) {
  return new Date(date).toLocaleTimeString(isRTL.value ? 'ar-SA' : 'en-US', { 
    hour: '2-digit', 
    minute: '2-digit' 
  })
}

function isActivityType(type: string) {
  return ['water_sports', 'activities', 'beach'].includes(type)
}

function getTypeLabel(type: string) {
  const labels: Record<string, string> = {
    room: isRTL.value ? 'ğŸ¨ ØºØ±ÙØ©' : 'ğŸ¨ Room',
    restaurant: isRTL.value ? 'ğŸ½ï¸ Ù…Ø·Ø¹Ù…' : 'ğŸ½ï¸ Restaurant',
    cafe: isRTL.value ? 'â˜• ÙƒØ§ÙÙŠÙ‡' : 'â˜• Cafe',
    water_sports: isRTL.value ? 'ğŸ„ Ø±ÙŠØ§Ø¶Ø© Ù…Ø§Ø¦ÙŠØ©' : 'ğŸ„ Water Sport',
    activities: isRTL.value ? 'ğŸ¯ Ù†Ø´Ø§Ø·' : 'ğŸ¯ Activity',
    beach: isRTL.value ? 'ğŸ–ï¸ Ø´Ø§Ø·Ø¦' : 'ğŸ–ï¸ Beach'
  }
  return labels[type] || type
}

function getStatusClass(status: string) {
  const classes: Record<string, string> = {
    pending: 'bg-yellow-100 text-yellow-800 border border-yellow-200',
    confirmed: 'bg-green-100 text-green-800 border border-green-200',
    cancelled: 'bg-red-100 text-red-800 border border-red-200',
    completed: 'bg-blue-100 text-blue-800 border border-blue-200'
  }
  return classes[status] || 'bg-gray-100 text-gray-800'
}

async function updateStatus(bookingId: number, status: string) {
  try {
    await apiClient.put(`/api/bookings/${bookingId}`, { status })
    await loadBookings()
  } catch (error) {
    console.error('Failed to update status:', error)
  }
}

onMounted(() => {
  loadBookings()
})
</script>
